{% extends "base.html" %}

{% block title %}{{ product.name }} - Comptoir de l'Ouest{% endblock %}

{% block content %}

<div class="product-page-container">
    
    <div class="back-nav">
        <a href="{{ url_for('catalog.products') }}" class="btn-back">← Retour au catalogue</a>
    </div>

    <div class="product-detail-wrapper">
        
        <div class="detail-image-box">
            {% if product.image %}
                <img src="{{ url_for('static', filename='img/products/' ~ product.image) }}" alt="{{ product.name }}">
            {% else %}
                <div class="no-image">Pas d'image</div>
            {% endif %}
        </div>

        <div class="detail-info-box">
            <span class="detail-brand">{{ product.brand or 'Artisanat' }}</span>
            <h1 class="detail-title">{{ product.name }}</h1>
            
            <div class="detail-price-row">
                <span class="detail-price">{{ product.price }} €</span>
                {% if product.stock_quantity > 0 %}
                    <span class="stock-status in-stock">En stock ({{ product.stock_quantity }})</span>
                {% else %}
                    <span class="stock-status out-stock">Rupture</span>
                {% endif %}
            </div>

            <p class="detail-description">{{ product.description }}</p>

            <div class="d-flex align-items-center mt-4">
    
                {% if product.stock_quantity > 0 %}
                    {% set max_qty = 5 if product.stock_quantity >= 5 else product.stock_quantity %}
                    
                    <select class="form-select me-3 quantity-select w-auto" id="qty-{{ product.id }}">
                        {% for i in range(1, max_qty + 1) %}
                            <option value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                    </select>

                    <button type="button" 
                        class="btn btn-primary add-to-cart-btn flex-grow-1" 
                        data-product-id="{{ product.id }}">
                        Ajouter au panier
                    </button>
                {% else %}
                    <button type="button" class="btn-add-cart" disabled>Indisponible</button>
                {% endif %}

            </div>
        </div>
    </div> 
</div> 

<script>
function addToCart(productId) {
    const qtySelect = document.getElementById(`qty-${productId}`);
    const quantity = qtySelect ? qtySelect.value : 1;

    fetch(`/api/cart/add/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ quantity: quantity })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const badge = document.getElementById('cart-item-count');
            if(badge) badge.innerText = data.cart_count;
            alert(data.message); 
        } else {
            alert("Erreur: " + data.error);
        }
    })
    .catch(error => console.error('Erreur:', error));
}
</script>

{% endblock %}